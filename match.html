<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>APEX-TC | Match</title>
  <style>
    :root{
      --bg:#070b16; --card: rgba(255,255,255,.06); --line: rgba(255,255,255,.10);
      --text:#eaf0ff; --muted: rgba(234,240,255,.70);
      --accent:#7c5cff; --good:#33d17a; --bad:#ff5c7a;
      --shadow: 0 20px 50px rgba(0,0,0,.45); --radius: 18px;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:var(--sans); color:var(--text); min-height:100vh;
      background:
        radial-gradient(1100px 500px at 20% 10%, rgba(124,92,255,.25), transparent 55%),
        radial-gradient(900px 500px at 85% 35%, rgba(51,209,122,.18), transparent 55%),
        var(--bg);
    }
    .wrap{max-width:900px; margin:0 auto; padding:20px 16px 60px;}
    header{display:flex; justify-content:space-between; align-items:center; gap:10px;}
    h1{margin:0; font-size:18px;}
    .pill{border:1px solid var(--line); background:rgba(255,255,255,.05); padding:8px 10px; border-radius:999px; color:var(--muted); font-size:13px;}
    .card{
      margin-top:12px;
      border:1px solid var(--line); background:var(--card); border-radius:var(--radius);
      box-shadow:var(--shadow); padding:16px; backdrop-filter: blur(10px);
    }
    label{display:block; font-size:12px; color:var(--muted); margin:10px 0 6px;}
    select,input{
      width:100%; padding:11px 12px; border-radius:14px; border:1px solid var(--line);
      background: rgba(0,0,0,.25); color:var(--text); outline:none;
    }
    .two{display:grid; grid-template-columns:1fr 1fr; gap:10px;}
    @media(max-width:600px){ .two{grid-template-columns:1fr;} }
    button{
      padding:11px 12px; border-radius:14px; border:1px solid rgba(124,92,255,.55);
      background: rgba(124,92,255,.18); color: var(--text); cursor:pointer;
    }
    .secondary{border-color: rgba(255,255,255,.22); background: rgba(255,255,255,.08);}
    .good{border-color: rgba(51,209,122,.55); background: rgba(51,209,122,.12);}
    .msg{margin-top:10px; font-size:13px;}
    .msg.good{color:var(--good)} .msg.bad{color:var(--bad)}
    .hint{color:var(--muted); font-size:13px; line-height:1.5;}
    .mono{font-family:var(--mono);}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <button class="secondary" onclick="location.href='index.html'">â† í™ˆ</button>
      <h1 id="title">Match</h1>
      <div class="pill" id="sync">players: loadingâ€¦</div>
    </header>

    <div class="card">
      <div class="hint" id="hintText">
        í•œ ì„¸íŠ¸ ê²Œì„ ìŠ¤ì½”ì–´ë¥¼ ì…ë ¥í•´ìš” (ì˜ˆ: 6:3, 7:5, 7:6).
      </div>

      <!-- âœ… Singles: í˜•ì‹ ì„ íƒ í™”ë©´ (format ì—†ì„ ë•Œ í‘œì‹œ) -->
      <div id="singlesPick" style="display:none; margin-top:10px;">
        <div class="hint" style="margin-top:0;">
          Singles ê²½ê¸° í˜•ì‹ì„ ì„ íƒí•´ì¤˜.
        </div>

        <div class="two" style="margin-top:12px;">
          <button class="good" id="pick6">ğŸ¾ 6-game (1 set)</button>
          <button class="secondary" id="pick10">ğŸ”¥ 10-point Tiebreak</button>
        </div>

        <div class="hint" style="margin-top:10px;">
          â€¢ 6-game: ì˜ˆ) 6:3, 7:5, 7:6<br/>
          â€¢ 10TB: íƒ€ì´ë¸Œë ˆì´í¬ ì ìˆ˜ (0~20, ìŠ¹ì 10ì  ì´ìƒ + 2ì  ì°¨)
        </div>
      </div>

      <div id="singlesBlock">
        <div class="two">
          <div>
            <label>Player A</label>
            <select id="sA"></select>
          </div>
          <div>
            <label>Player B</label>
            <select id="sB"></select>
          </div>
        </div>
      </div>

      <div id="doublesBlock" style="display:none;">
        <div class="two">
          <div><label>Team A - 1</label><select id="dA1"></select></div>
          <div><label>Team A - 2</label><select id="dA2"></select></div>
        </div>
        <div class="two" style="margin-top:8px;">
          <div><label>Team B - 1</label><select id="dB1"></select></div>
          <div><label>Team B - 2</label><select id="dB2"></select></div>
        </div>
      </div>

      <div class="two" style="margin-top:10px;">
        <div>
          <label id="labelA">Games A</label>
          <input id="gamesA" type="number" min="0" max="7" placeholder="ì˜ˆ: 6" />
        </div>
        <div>
          <label id="labelB">Games B</label>
          <input id="gamesB" type="number" min="0" max="7" placeholder="ì˜ˆ: 3" />
        </div>
      </div>

      <div class="two" style="margin-top:12px;">
        <button class="good" id="saveBtn">ì €ì¥</button>
        <button class="secondary" onclick="location.href='players.html'">ì°¸ê°€ì ê´€ë¦¬ë¡œ</button>
      </div>

      <div class="msg" id="msg"></div>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

    const SUPABASE_URL = "https://bojzlfjtjzpdyhcyzzvu.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_u-o3XzuBwFRbG2woRNsPkA_GPlLIdE2";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const $ = (id)=>document.getElementById(id);
    const params = new URLSearchParams(location.search);

    const mode = (params.get("mode") || "singles").toLowerCase();
    const format = (params.get("format") || "").toLowerCase(); // "6game" | "10tb" | ""

    const title = $("title");
    const sync = $("sync");
    const msg = $("msg");

    const singlesPick = $("singlesPick");
    const singlesBlock = $("singlesBlock");
    const doublesBlock = $("doublesBlock");

    const hintText = $("hintText");
    const labelA = $("labelA");
    const labelB = $("labelB");
    const inputA = $("gamesA");
    const inputB = $("gamesB");

    function setMsg(text, kind=""){
      msg.className = "msg " + kind;
      msg.textContent = text;
    }

    function fillSelect(sel, players){
      sel.innerHTML = `<option value="">â€” ì„ íƒ â€”</option>`;
      for(const p of players){
        const opt = document.createElement("option");
        opt.value = p.id;
        opt.textContent = p.name;
        sel.appendChild(opt);
      }
    }

    async function loadPlayers(){
      const { data, error } = await supabase
        .from("players")
        .select("id, name")
        .order("name", { ascending: true });

      if(error){
        sync.textContent = "players: error";
        console.error(error);
        return [];
      }
      sync.textContent = `players: ${data.length}`;
      return data;
    }

    function validateGames6(a,b){
      if(!Number.isFinite(a) || !Number.isFinite(b)) return "ê²Œì„ ìŠ¤ì½”ì–´ë¥¼ ì…ë ¥í•´ì¤˜.";
      if(a === b) return "ë¬´ìŠ¹ë¶€ëŠ” ì•ˆ ë¼.";
      if(a < 0 || b < 0 || a > 7 || b > 7) return "ê²Œì„ì€ 0~7 ë²”ìœ„ë¡œ ì…ë ¥í•´ì¤˜.";

      const hi = Math.max(a,b), lo = Math.min(a,b);
      const ok =
        (hi === 6 && lo <= 4) ||
        (hi === 7 && (lo === 5 || lo === 6));

      if(!ok) return "ê°€ëŠ¥í•œ í•œ ì„¸íŠ¸ ìŠ¤ì½”ì–´ ì˜ˆ: 6:3, 6:4, 7:5, 7:6";
      return null;
    }

    function validateTB10(a,b){
      if(!Number.isFinite(a) || !Number.isFinite(b)) return "íƒ€ì´ë¸Œë ˆì´í¬ ì ìˆ˜ë¥¼ ì…ë ¥í•´ì¤˜.";
      if(a === b) return "ë¬´ìŠ¹ë¶€ëŠ” ì•ˆ ë¼.";
      if(a < 0 || b < 0 || a > 20 || b > 20) return "íƒ€ì´ë¸Œë ˆì´í¬ëŠ” 0~20 ë²”ìœ„ë¡œ ì…ë ¥í•´ì¤˜.";

      const hi = Math.max(a,b), lo = Math.min(a,b);
      if(hi < 10) return "10ì  íƒ€ì´ë¸Œë ˆì´í¬ëŠ” ìŠ¹ìê°€ ìµœì†Œ 10ì  ì´ìƒì´ì–´ì•¼ í•´.";
      if(hi - lo < 2) return "íƒ€ì´ë¸Œë ˆì´í¬ëŠ” 2ì  ì°¨ë¡œ ì´ê²¨ì•¼ í•´. (ì˜ˆ: 10:8, 12:10, 20:18)";
      return null;
    }

    function allUnique(arr){
      const clean = arr.filter(Boolean);
      return new Set(clean).size === clean.length;
    }

    function showSinglesPick(){
      hintText.textContent = "Singles ê²½ê¸° í˜•ì‹ì„ ì„ íƒí•´ì¤˜.";
      singlesPick.style.display = "block";
      singlesBlock.style.display = "none";
      doublesBlock.style.display = "none";

      // ì ìˆ˜ ì…ë ¥/ì €ì¥ ë²„íŠ¼ì€ ì„ íƒ ì „ì—ëŠ” ìˆ¨ê¸°ë©´ ê¹”ë”í•¨
      inputA.closest(".two").style.display = "none";
      $("saveBtn").style.display = "none";

      $("pick6").onclick = () => location.href = "match.html?mode=singles&format=6game";
      $("pick10").onclick = () => location.href = "match.html?mode=singles&format=10tb";
    }

    function applySinglesFormatUI(fmt){
      // ì ìˆ˜ ì…ë ¥/ì €ì¥ ë‹¤ì‹œ ë³´ì´ê¸°
      inputA.closest(".two").style.display = "";
      $("saveBtn").style.display = "";

      if(fmt === "10tb"){
        hintText.textContent = "10ì  íƒ€ì´ë¸Œë ˆì´í¬ ì ìˆ˜ë¥¼ ì…ë ¥í•´ìš”. (0~20, ìŠ¹ì 10ì  ì´ìƒ + 2ì  ì°¨)";
        labelA.textContent = "TB Points A";
        labelB.textContent = "TB Points B";
        inputA.min = "0"; inputA.max = "20"; inputA.placeholder = "ì˜ˆ: 10";
        inputB.min = "0"; inputB.max = "20"; inputB.placeholder = "ì˜ˆ: 8";
      } else {
        hintText.textContent = "í•œ ì„¸íŠ¸ ê²Œì„ ìŠ¤ì½”ì–´ë¥¼ ì…ë ¥í•´ìš” (ì˜ˆ: 6:3, 7:5, 7:6).";
        labelA.textContent = "Games A";
        labelB.textContent = "Games B";
        inputA.min = "0"; inputA.max = "7"; inputA.placeholder = "ì˜ˆ: 6";
        inputB.min = "0"; inputB.max = "7"; inputB.placeholder = "ì˜ˆ: 3";
      }
    }

    async function saveMatch(){
      const a = Number(inputA.value);
      const b = Number(inputB.value);

      let err = null;
      if(mode === "singles" && format === "10tb") err = validateTB10(a, b);
      else err = validateGames6(a, b);

      if(err){ setMsg(err, "bad"); return; }

      let team_a=[], team_b=[];
      if(mode === "singles"){
        const A = $("sA").value, B = $("sB").value;
        if(!A || !B) { setMsg("í”Œë ˆì´ì–´ A/Bë¥¼ ì„ íƒí•´ì¤˜.", "bad"); return; }
        if(A===B) { setMsg("ê°™ì€ ì‚¬ëŒì„ ë‘˜ ë‹¤ ì„ íƒí•  ìˆ˜ ì—†ì–´.", "bad"); return; }
        team_a=[A]; team_b=[B];
      }else{
        const A1=$("dA1").value, A2=$("dA2").value, B1=$("dB1").value, B2=$("dB2").value;
        if(!A1||!A2||!B1||!B2){ setMsg("ë”ë¸”ì€ 4ëª…ì„ ëª¨ë‘ ì„ íƒí•´ì¤˜.", "bad"); return; }
        if(!allUnique([A1,A2,B1,B2])){ setMsg("ë”ë¸”ì—ì„œ ê°™ì€ ì‚¬ëŒì„ ì¤‘ë³µ ì„ íƒí•  ìˆ˜ ì—†ì–´.", "bad"); return; }
        team_a=[A1,A2]; team_b=[B1,B2];
      }

      setMsg("ì €ì¥ ì¤‘â€¦");
      const { error } = await supabase.from("matches").insert({
        mode,
        team_a,
        team_b,
        games_a: a,
        games_b: b
        // ë‚˜ì¤‘ì— DB ì»¬ëŸ¼ ì¶”ê°€í•˜ë©´: score_format: format
      });

      if(error){
        setMsg("ì €ì¥ ì‹¤íŒ¨: " + error.message, "bad");
        return;
      }
      setMsg("ì €ì¥ ì™„ë£Œ!", "good");
      inputA.value=""; inputB.value="";
    }

    // âœ… í™”ë©´ ì´ˆê¸°í™”
    if(mode === "doubles"){
      title.textContent = "Doubles Match";
      singlesPick.style.display = "none";
      singlesBlock.style.display = "none";
      doublesBlock.style.display = "block";
    } else {
      title.textContent = "Singles Match";
      doublesBlock.style.display = "none";

      // format ì—†ìœ¼ë©´ ì„ íƒ UI
      if(!["6game","10tb"].includes(format)){
        showSinglesPick();
      } else {
        singlesPick.style.display = "none";
        singlesBlock.style.display = "block";
        applySinglesFormatUI(format);
      }
    }

    // âœ… ì„ íƒ í™”ë©´ì´ë©´ êµ³ì´ ë¡œë”© ì•ˆ í•´ë„ ë˜ì§€ë§Œ, UXìƒ players ìˆ˜ ë³´ì—¬ì£¼ë ¤ê³  ë¡œë”©ì€ í•´ë‘ 
    const players = await loadPlayers();
    fillSelect($("sA"), players); fillSelect($("sB"), players);
    fillSelect($("dA1"), players); fillSelect($("dA2"), players);
    fillSelect($("dB1"), players); fillSelect($("dB2"), players);

    $("saveBtn").addEventListener("click", saveMatch);
  </script>
</body>
</html>
