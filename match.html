<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

  const SUPABASE_URL = "https://bojzlfjtjzpdyhcyzzvu.supabase.co";
  const SUPABASE_ANON_KEY = "sb_publishable_u-o3XzuBwFRbG2woRNsPkA_GPlLIdE2";
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const $ = (id)=>document.getElementById(id);
  const params = new URLSearchParams(location.search);
  const mode = (params.get("mode") || "singles").toLowerCase();

  // singles format: "6game" | "10tb"
  let format = (params.get("format") || "6game").toLowerCase();
  if(!["6game","10tb"].includes(format)) format = "6game";

  const title = $("title");
  const sync = $("sync");
  const msg = $("msg");

  const singlesBlock = $("singlesBlock");
  const doublesBlock = $("doublesBlock");

  function setMsg(text, kind=""){
    msg.className = "msg " + kind;
    msg.textContent = text;
  }

  function fillSelect(sel, players){
    sel.innerHTML = `<option value="">— 선택 —</option>`;
    for(const p of players){
      const opt = document.createElement("option");
      opt.value = p.id;
      opt.textContent = p.name;
      sel.appendChild(opt);
    }
  }

  async function loadPlayers(){
    const { data, error } = await supabase
      .from("players")
      .select("id, name")
      .order("name", { ascending: true });

    if(error){
      sync.textContent = "players: error";
      console.error(error);
      return [];
    }
    sync.textContent = `players: ${data.length}`;
    return data;
  }

  // ✅ 기존 6-game 검증
  function validateGames6(a,b){
    if(!Number.isFinite(a) || !Number.isFinite(b)) return "게임 스코어를 입력해줘.";
    if(a === b) return "무승부는 안 돼.";
    if(a < 0 || b < 0 || a > 7 || b > 7) return "게임은 0~7 범위로 입력해줘.";

    const hi = Math.max(a,b), lo = Math.min(a,b);
    const ok =
      (hi === 6 && lo <= 4) ||
      (hi === 7 && (lo === 5 || lo === 6));

    if(!ok) return "가능한 한 세트 스코어 예: 6:3, 6:4, 7:5, 7:6";
    return null;
  }

  // ✅ 10-point tiebreak 검증 (0~20, 10 이상 승리, 2점 차)
  function validateTB10(a,b){
    if(!Number.isFinite(a) || !Number.isFinite(b)) return "타이브레이크 점수를 입력해줘.";
    if(a === b) return "무승부는 안 돼.";
    if(a < 0 || b < 0 || a > 20 || b > 20) return "타이브레이크는 0~20 범위로 입력해줘.";

    const hi = Math.max(a,b), lo = Math.min(a,b);
    if(hi < 10) return "10점 타이브레이크는 승자가 최소 10점 이상이어야 해.";
    if(hi - lo < 2) return "타이브레이크는 2점 차로 이겨야 해. (예: 10:8, 12:10, 20:18)";
    return null;
  }

  function allUnique(arr){
    const clean = arr.filter(Boolean);
    return new Set(clean).size === clean.length;
  }

  // ✅ UI: singles format 선택 박스 + 안내문/라벨 변경
  function mountSinglesFormatUI(){
    if(mode !== "singles") return;

    // hint 문구 영역(기존 .hint div)을 가져와서 내용만 바꿀 거야
    const hintEl = document.querySelector(".card .hint");
    const gamesALabel = document.querySelector('label[for="gamesA"]') || null;

    // label이 for가 없어서 안전하게 직접 교체
    const gamesALabelEl = $("gamesA").closest("div").querySelector("label");
    const gamesBLabelEl = $("gamesB").closest("div").querySelector("label");

    // singlesBlock 맨 위에 format 선택을 끼워넣기
    const formatRow = document.createElement("div");
    formatRow.style.marginTop = "12px";
    formatRow.innerHTML = `
      <label>Singles Format</label>
      <select id="formatSel">
        <option value="6game">6 game (1 set)</option>
        <option value="10tb">10-point Tiebreak</option>
      </select>
    `;
    singlesBlock.prepend(formatRow);

    const formatSel = $("formatSel");
    formatSel.value = format;

    function applyFormatUI(){
      // URL도 같이 바꿔서 새로고침/공유해도 유지되게
      const next = new URL(location.href);
      next.searchParams.set("mode", "singles");
      next.searchParams.set("format", format);
      history.replaceState(null, "", next.toString());

      if(format === "10tb"){
        hintEl.textContent = "10점 타이브레이크 점수를 입력해요. (최대 20점, 승자는 10점 이상 + 2점 차)";
        gamesALabelEl.textContent = "TB Points A";
        gamesBLabelEl.textContent = "TB Points B";
        $("gamesA").min = "0"; $("gamesA").max = "20"; $("gamesA").placeholder = "예: 10";
        $("gamesB").min = "0"; $("gamesB").max = "20"; $("gamesB").placeholder = "예: 8";
      }else{
        hintEl.textContent = "한 세트 게임 스코어를 입력해요 (예: 6:3, 7:5, 7:6).";
        gamesALabelEl.textContent = "Games A";
        gamesBLabelEl.textContent = "Games B";
        $("gamesA").min = "0"; $("gamesA").max = "7"; $("gamesA").placeholder = "예: 6";
        $("gamesB").min = "0"; $("gamesB").max = "7"; $("gamesB").placeholder = "예: 3";
      }
    }

    formatSel.addEventListener("change", () => {
      format = formatSel.value;
      setMsg(""); // 메시지 초기화
      // 점수 입력칸도 초기화
      $("gamesA").value = ""; $("gamesB").value = "";
      applyFormatUI();
    });

    applyFormatUI();
  }

  async function saveMatch(){
    const a = Number($("gamesA").value);
    const b = Number($("gamesB").value);

    // ✅ mode/format에 따라 검증 분기
    let err = null;
    if(mode === "singles" && format === "10tb") err = validateTB10(a, b);
    else err = validateGames6(a, b);

    if(err){ setMsg(err, "bad"); return; }

    let team_a=[], team_b=[];
    if(mode === "singles"){
      const A = $("sA").value, B = $("sB").value;
      if(!A || !B) { setMsg("플레이어 A/B를 선택해줘.", "bad"); return; }
      if(A===B) { setMsg("같은 사람을 둘 다 선택할 수 없어.", "bad"); return; }
      team_a=[A]; team_b=[B];
    }else{
      const A1=$("dA1").value, A2=$("dA2").value, B1=$("dB1").value, B2=$("dB2").value;
      if(!A1||!A2||!B1||!B2){ setMsg("더블은 4명을 모두 선택해줘.", "bad"); return; }
      if(!allUnique([A1,A2,B1,B2])){ setMsg("더블에서 같은 사람을 중복 선택할 수 없어.", "bad"); return; }
      team_a=[A1,A2]; team_b=[B1,B2];
    }

    setMsg("저장 중…");

    // ✅ DB 컬럼 추가 없이도 일단 저장되게: games_a/games_b에 그대로 넣음
    // (format 구분 저장은 다음 단계에서 matches에 컬럼 추가하면 같이 넣어주자)
    const payload = {
      mode,            // singles / doubles (그대로)
      team_a,
      team_b,
      games_a: a,      // 6game이면 게임 수 / 10tb면 타이브레이크 포인트
      games_b: b
    };

    const { error } = await supabase.from("matches").insert(payload);

    if(error){
      setMsg("저장 실패: " + error.message, "bad");
      return;
    }
    setMsg("저장 완료!", "good");
    $("gamesA").value=""; $("gamesB").value="";
  }

  // 화면 초기화
  if(mode === "doubles"){
    title.textContent = "Doubles Match";
    singlesBlock.style.display = "none";
    doublesBlock.style.display = "block";
  }else{
    title.textContent = "Singles Match";
    singlesBlock.style.display = "block";
    doublesBlock.style.display = "none";
  }

  // ✅ singles format UI 장착
  mountSinglesFormatUI();

  const players = await loadPlayers();
  fillSelect($("sA"), players); fillSelect($("sB"), players);
  fillSelect($("dA1"), players); fillSelect($("dA2"), players);
  fillSelect($("dB1"), players); fillSelect($("dB2"), players);

  $("saveBtn").addEventListener("click", saveMatch);
</script>
